<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <%- include('partials/head') %>
</head>
<body class="h-full bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-gray-100" x-data="{ sidebarOpen: true }">
    <%- include('partials/sidebar') %>

    <!-- Main Content -->
    <div class="transition-all duration-300" :class="sidebarOpen ? 'ml-64' : 'ml-20'">
        <div class="flex flex-col min-h-screen">
            <%- include('partials/header') %>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-6">
                <!-- Flash Messages -->
                <%- include('partials/flash') %>

                <!-- Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Devices Card -->
                    <div class="group relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700/50 hover:border-blue-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/10 hover:-translate-y-1">
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg">
                                    <i class="fas fa-server text-white text-xl"></i>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-blue-400 font-medium uppercase tracking-wider">Total</p>
                                    <p class="text-xs text-gray-400">Devices</p>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <p class="text-3xl font-bold text-white"><%= Object.keys(devices).length %></p>
                                <p class="text-sm text-gray-400 font-medium">SNMP Monitored</p>
                            </div>
                        </div>
                    </div>

                    <!-- Interfaces Card -->
                    <div class="group relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700/50 hover:border-purple-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-purple-500/10 hover:-translate-y-1">
                        <div class="absolute inset-0 bg-gradient-to-br from-purple-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg">
                                    <i class="fas fa-network-wired text-white text-xl"></i>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-purple-400 font-medium uppercase tracking-wider">Total</p>
                                    <p class="text-xs text-gray-400">Interfaces</p>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <p class="text-3xl font-bold text-white"><%= interfaces.length %></p>
                                <p class="text-sm text-gray-400 font-medium">Network Interfaces</p>
                            </div>
                        </div>
                    </div>

                    <!-- Ping Targets Card -->
                    <div class="group relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700/50 hover:border-yellow-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-yellow-500/10 hover:-translate-y-1">
                        <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg shadow-lg">
                                    <i class="fas fa-bullseye text-white text-xl"></i>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-yellow-400 font-medium uppercase tracking-wider">Active</p>
                                    <p class="text-xs text-gray-400">Targets</p>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <p class="text-3xl font-bold text-white"><%= pingTargets.length %></p>
                                <p class="text-sm text-gray-400 font-medium">Ping Monitoring</p>
                            </div>
                        </div>
                    </div>

                    <!-- System Status Card -->
                    <div class="group relative overflow-hidden bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border border-slate-700/50 hover:border-emerald-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-emerald-500/10 hover:-translate-y-1">
                        <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-lg shadow-lg">
                                    <i class="fas fa-check-circle text-white text-xl"></i>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-emerald-400 font-medium uppercase tracking-wider">System</p>
                                    <p class="text-xs text-gray-400">Status</p>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <p class="text-3xl font-bold text-emerald-400">Operational</p>
                                <p class="text-sm text-gray-400 font-medium">All Systems Go</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ping Status Section -->
                <% if (groupedPingTargets && Object.keys(groupedPingTargets).length > 0) { %>
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl border border-slate-700/50 p-6 shadow-xl mb-8">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-3">
                            <div class="p-2 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg shadow-lg">
                                <i class="fas fa-bullseye text-white"></i>
                            </div>
                            Ping Monitoring Status
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <% Object.entries(groupedPingTargets).forEach(([group, targets]) => { %>
                                <div class="bg-gradient-to-br from-slate-700/50 to-slate-800/50 rounded-lg p-4 border border-slate-600/30">
                                    <h4 class="text-white font-semibold mb-3 flex items-center gap-2">
                                        <i class="fas fa-folder text-yellow-400"></i>
                                        <%= group %>
                                    </h4>
                                    <div class="space-y-3">
                                        <% targets.forEach(target => { %>
                                            <div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-600/20 hover:border-slate-500/30 transition-colors">
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-medium text-white truncate"><%= target.name %></p>
                                                    <p class="text-xs text-gray-400 mt-1 truncate"><%= target.host %></p>
                                                </div>
                                                <div class="status-indicator ml-2 flex-shrink-0">
                                                    <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between pt-3 border-t border-slate-600/50">
                                                <div class="text-xs">
                                                    <span class="text-gray-400">Latency:</span>
                                                    <span class="latency text-white font-semibold ml-1">--ms</span>
                                                </div>
                                                <div class="text-xs">
                                                    <span class="text-gray-400">Loss:</span>
                                                    <span class="packet-loss text-white font-semibold ml-1">--%</span>
                                                </div>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                <% } %>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Devices Overview -->
                    <div class="lg:col-span-2">
                        <!-- Device Cards -->
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl border border-slate-700/50 p-6 shadow-xl mb-8 hover:shadow-2xl transition-all duration-300">
                            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-3">
                                <div class="p-2 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg">
                                    <i class="fas fa-server text-white"></i>
                                </div>
                                Monitored Devices
                            </h3>

                            <div class="space-y-4">
                                <% Object.entries(devices).forEach(([deviceId, device]) => { %>
                                    <a href="/monitoring?device=<%= deviceId %>" class="group block p-4 bg-gradient-to-r from-slate-700/50 to-slate-800/50 hover:from-slate-600 hover:to-slate-700 rounded-lg border border-slate-600/30 hover:border-slate-500/50 transition-all duration-200 hover:shadow-lg hover:shadow-slate-900/30 hover:-translate-y-0.5">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                                                        <i class="fas fa-server text-white text-sm"></i>
                                                    </div>
                                                    <div>
                                                        <p class="font-semibold text-white group-hover:text-blue-400 transition-colors"><%= device.name %></p>
                                                        <p class="text-sm text-gray-400"><%= device.host %></p>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-4 text-xs">
                                                    <div class="flex items-center gap-1">
                                                        <i class="fas fa-network-wired text-purple-400"></i>
                                                        <span class="text-gray-300"><%= device.selectedInterfaces ? device.selectedInterfaces.length : 0 %> interfaces</span>
                                                    </div>
                                                    <div class="flex items-center gap-1">
                                                        <i class="fas fa-clock text-green-400"></i>
                                                        <span class="text-gray-300"><%= device.pollingInterval || 30 %>s poll</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                                                <i class="fas fa-chevron-right text-gray-400 group-hover:text-blue-400 transition-colors"></i>
                                            </div>
                                        </div>
                                    </a>
                                <% }); %>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="lg:col-span-1">
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl border border-slate-700/50 p-6 shadow-xl sticky top-24">
                            <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-3">
                                <div class="p-2 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg shadow-lg">
                                    <i class="fas fa-history text-white"></i>
                                </div>
                                Recent Activity
                            </h3>

                            <div class="space-y-4" id="recent-activity">
                                <div class="flex items-start gap-3 p-3 bg-slate-700/30 rounded-lg border border-slate-600/20">
                                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-server text-white text-xs"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-white">System initialized</p>
                                        <p class="text-xs text-gray-400 mt-1">Dashboard loaded successfully</p>
                                        <p class="text-xs text-gray-500 mt-2"><i class="fas fa-clock mr-1"></i>Just now</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <div class="transition-all duration-300" :class="sidebarOpen ? 'ml-64' : 'ml-20'">
        <%- include('partials/footer') %>
    </div>

    <script>
        // Time display
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Ping status updates
        async function updatePingStatus() {
            try {
                console.log('Fetching ping status...');
                const response = await fetch('/api/debug/ping-status', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                console.log('Ping status data:', data);

                if (!data.details) {
                    console.error('No details in ping status response');
                    return;
                }

                const latencyElements = document.querySelectorAll('.latency');
                const packetLossElements = document.querySelectorAll('.packet-loss');
                const statusElements = document.querySelectorAll('.status-indicator div');

                console.log('Found elements:', {
                    latency: latencyElements.length,
                    packetLoss: packetLossElements.length,
                    status: statusElements.length,
                    details: data.details.length
                });

                // Update latency and packet loss for each target
                latencyElements.forEach((el, index) => {
                    if (data.details[index]) {
                        el.textContent = data.details[index].latency + 'ms';
                    }
                });

                packetLossElements.forEach((el, index) => {
                    if (data.details[index]) {
                        el.textContent = data.details[index].loss + '%';
                    }
                });

                // Update status indicators
                statusElements.forEach((indicator, index) => {
                    if (data.details[index]) {
                        const status = data.details[index].status;
                        indicator.className = `w-2 h-2 rounded-full animate-pulse ${
                            status === 'online' ? 'bg-green-400' :
                            status === 'offline' ? 'bg-red-400' : 'bg-yellow-400'
                        }`;
                    }
                });

                console.log('Ping status updated successfully');
            } catch (error) {
                console.error('Failed to fetch ping status:', error);
            }
        }

        // Initialize after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            updatePingStatus();

            // Update every 30 seconds
            setInterval(updatePingStatus, 30000);
        });
    </script>
</body>
</html>